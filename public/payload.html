<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MapPack ‚Äî Survey Data Packager</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --bg: #0f1117;
      --card: #161c2a;
      --edge: #1e2a40;
      --edge2: #283a58;
      --txt: #c4d0e8;
      --dim: #5a7090;
      --faint: #2e3f5c;
      --grn: #2dc98a;
      --blu: #3d7fff;
      --amb: #f0a030;
      --red: #e05050;
      --mono: 'JetBrains Mono', monospace;
      --sans: 'Inter', sans-serif;
    }

    html,
    body {
      height: 100%;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--txt);
      font-size: 14px;
    }

    /* HEADER */
    header {
      height: 54px;
      background: var(--card);
      border-bottom: 1px solid var(--edge);
      display: flex;
      align-items: center;
      padding: 0 24px;
      gap: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, #1a5fd4, #0d9e6e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo-name {
      font-weight: 600;
      font-size: 15px
    }

    .logo-name em {
      color: var(--grn);
      font-style: normal
    }

    .logo-ver {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--faint);
      border: 1px solid var(--edge);
      border-radius: 3px;
      padding: 1px 7px;
      margin-left: 2px;
    }

    .hdr-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--dim);
    }

    .pulse {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--grn);
      box-shadow: 0 0 6px var(--grn);
      animation: blink 2.4s infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .25
      }
    }

    /* TABS */
    .tabs {
      background: var(--card);
      border-bottom: 1px solid var(--edge);
      display: flex;
      padding: 0 24px;
      gap: 0;
    }

    .tab {
      padding: 13px 22px;
      font-size: 13px;
      font-weight: 500;
      color: var(--dim);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .15s;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .tab:hover {
      color: var(--txt)
    }

    .tab.on {
      color: var(--blu);
      border-bottom-color: var(--blu)
    }

    /* CONTENT */
    main {
      max-width: 680px;
      margin: 28px auto 60px;
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .view {
      display: none
    }

    .view.on {
      display: flex;
      flex-direction: column;
      gap: 14px
    }

    /* CARD */
    .card {
      background: var(--card);
      border: 1px solid var(--edge);
      border-radius: 10px;
      overflow: hidden
    }

    .card-hd {
      background: #131929;
      border-bottom: 1px solid var(--edge);
      padding: 10px 18px;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .card-hd span {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--dim);
      letter-spacing: .07em;
      text-transform: uppercase
    }

    .card-bd {
      padding: 18px
    }

    /* FIELDS */
    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 14px
    }

    .field:last-child {
      margin-bottom: 0
    }

    .field>label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--dim);
      letter-spacing: .05em;
      text-transform: uppercase
    }

    .hint {
      font-size: 11px;
      color: var(--faint);
      margin-top: 2px
    }

    .g2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px
    }

    .g3 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px
    }

    /* PATH ROW */
    .path-row {
      display: flex
    }

    .path-input {
      flex: 1;
      background: #0d1320;
      border: 1px solid var(--edge);
      border-right: none;
      border-radius: 6px 0 0 6px;
      padding: 9px 12px;
      color: var(--txt);
      font-family: var(--mono);
      font-size: 12px;
      outline: none;
      transition: border-color .15s;
    }

    .path-input:focus {
      border-color: var(--blu)
    }

    .path-input::placeholder {
      color: var(--faint)
    }

    .path-btn {
      background: var(--edge);
      border: 1px solid var(--edge);
      border-radius: 0 6px 6px 0;
      padding: 0 16px;
      color: var(--dim);
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      transition: all .15s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .path-btn:hover {
      background: var(--edge2);
      color: var(--txt)
    }

    .path-file {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0
    }

    /* KEY INPUT */
    .key-wrap {
      position: relative
    }

    .key-in {
      width: 100%;
      background: #0d1320;
      border: 1px solid var(--edge);
      border-radius: 6px;
      padding: 9px 40px 9px 12px;
      color: var(--amb);
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      letter-spacing: .07em;
      transition: border-color .15s;
    }

    .key-in:focus {
      border-color: var(--amb);
      box-shadow: 0 0 0 2px rgba(240, 160, 48, .06)
    }

    .key-in::placeholder {
      color: var(--faint);
      letter-spacing: .05em
    }

    .eye {
      position: absolute;
      right: 11px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--faint);
      font-size: 14px;
      padding: 2px;
      transition: color .15s;
      line-height: 1;
    }

    .eye:hover {
      color: var(--dim)
    }

    /* REGULAR INPUT / SELECT */
    .inp {
      width: 100%;
      background: #0d1320;
      border: 1px solid var(--edge);
      border-radius: 6px;
      padding: 9px 12px;
      color: var(--txt);
      font-family: var(--mono);
      font-size: 12px;
      outline: none;
      transition: border-color .15s;
    }

    .inp:focus {
      border-color: var(--blu)
    }

    .inp::placeholder {
      color: var(--faint)
    }

    select.inp option {
      background: #0d1320
    }

    /* UNIT COMBO */
    .unit-row {
      display: flex
    }

    .unit-in {
      flex: 1;
      background: #0d1320;
      border: 1px solid var(--edge);
      border-right: none;
      border-radius: 6px 0 0 6px;
      padding: 9px 12px;
      color: var(--txt);
      font-family: var(--mono);
      font-size: 12px;
      outline: none;
      transition: border-color .15s;
    }

    .unit-in:focus {
      border-color: var(--blu)
    }

    .unit-sel {
      background: var(--edge);
      border: 1px solid var(--edge);
      border-radius: 0 6px 6px 0;
      padding: 0 12px;
      color: var(--dim);
      font-family: var(--mono);
      font-size: 12px;
      outline: none;
      cursor: pointer;
    }

    .unit-sel option {
      background: #0d1320
    }

    /* DIVIDER */
    hr.sep {
      border: none;
      border-top: 1px solid var(--edge);
      margin: 14px 0
    }

    /* BUTTONS */
    .btn-row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .btn {
      padding: 10px 22px;
      border-radius: 7px;
      border: none;
      cursor: pointer;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .04em;
      font-weight: 500;
      transition: all .15s;
      display: inline-flex;
      align-items: center;
      gap: 7px;
    }

    .btn-blu {
      background: linear-gradient(135deg, #1f5ed4, #1048a8);
      color: #ddeeff;
      box-shadow: 0 0 14px rgba(31, 94, 212, .3)
    }

    .btn-blu:hover:not(:disabled) {
      box-shadow: 0 0 22px rgba(31, 94, 212, .5);
      transform: translateY(-1px)
    }

    .btn-grn {
      background: linear-gradient(135deg, #1a7a50, #125e3c);
      color: #c0f0da;
      box-shadow: 0 0 14px rgba(26, 122, 80, .3)
    }

    .btn-grn:hover:not(:disabled) {
      box-shadow: 0 0 22px rgba(26, 122, 80, .5);
      transform: translateY(-1px)
    }

    .btn-gh {
      background: transparent;
      border: 1px solid var(--edge);
      color: var(--dim)
    }

    .btn-gh:hover:not(:disabled) {
      border-color: var(--edge2);
      color: var(--txt)
    }

    .btn:disabled {
      opacity: .35;
      cursor: not-allowed;
      transform: none !important
    }

    /* PROGRESS */
    .prog {
      display: none;
      margin-top: 14px
    }

    .prog.on {
      display: block
    }

    .prog-top {
      display: flex;
      justify-content: space-between;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--dim);
      margin-bottom: 5px
    }

    .prog-track {
      background: #0d1320;
      border: 1px solid var(--edge);
      border-radius: 3px;
      height: 4px;
      overflow: hidden
    }

    .prog-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--blu), var(--grn));
      border-radius: 3px;
      width: 0;
      transition: width .25s
    }

    /* LOG */
    .log {
      background: #080c13;
      border: 1px solid var(--edge);
      border-radius: 6px;
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--dim);
      height: 100px;
      overflow-y: auto;
      line-height: 1.8;
      margin-top: 14px;
    }

    .ll {
      display: block
    }

    .ll.ok {
      color: var(--grn)
    }

    .ll.er {
      color: var(--red)
    }

    .ll.hi {
      color: var(--blu)
    }

    /* NOTICE */
    .note {
      border-radius: 6px;
      padding: 9px 13px;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      margin-top: 10px
    }

    .note.on {
      display: flex
    }

    .note-ok {
      background: rgba(45, 201, 138, .07);
      border: 1px solid rgba(45, 201, 138, .2);
      color: var(--grn)
    }

    .note-er {
      background: rgba(224, 80, 80, .07);
      border: 1px solid rgba(224, 80, 80, .2);
      color: var(--red)
    }

    /* FOOTER */
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 24px;
      background: var(--card);
      border-top: 1px solid var(--edge);
      display: flex;
      align-items: center;
      padding: 0 18px;
      gap: 14px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--faint);
    }

    footer .ok {
      color: var(--grn)
    }

    ::-webkit-scrollbar {
      width: 4px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    ::-webkit-scrollbar-thumb {
      background: var(--edge);
      border-radius: 2px
    }

    @media(max-width:520px) {

      .g2,
      .g3 {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">
      <div class="logo-icon">üó∫</div>
      <div class="logo-name">Map<em>Pack</em></div>
      <div class="logo-ver">v2.1</div>
    </div>
    <div class="hdr-right">
      <div class="pulse"></div>
      Survey Data Packager
    </div>
  </header>

  <div class="tabs">
    <div class="tab on" onclick="sw('pack',this)">üì¶ Pack</div>
    <div class="tab" onclick="sw('unpack',this)">üìÇ Unpack</div>
  </div>

  <main>

    <!-- ‚ïê‚ïê PACK ‚ïê‚ïê -->
    <div class="view on" id="v-pack">

      <div class="card">
        <div class="card-hd"><span>üìÇ Source file</span></div>
        <div class="card-bd">
          <div class="field" style="position:relative">
            <label>File path</label>
            <div class="path-row">
              <input class="path-input" id="pPath" readonly placeholder="No file selected ‚Äî click Browse" />
              <button class="path-btn" onclick="document.getElementById('pFile').click()">üìÅ Browse‚Ä¶</button>
              <input type="file" id="pFile" class="path-file" />
            </div>
            <div class="hint">Accepts any file type ‚Äî KMZ, KML, CSV, XLSX, ZIP, etc.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-hd"><span>‚öô Pack settings</span></div>
        <div class="card-bd">

          <div class="g2" style="margin-bottom:14px">
            <div class="field">
              <label>Survey key</label>
              <div class="key-wrap">
                <input class="key-in" type="password" id="pKey" placeholder="Enter survey key‚Ä¶" autocomplete="off" />
                <button class="eye" onclick="toggleEye('pKey',this)">üëÅ</button>
              </div>
            </div>
            <div class="field">
              <label>Confirm key</label>
              <div class="key-wrap">
                <input class="key-in" type="password" id="pKey2" placeholder="Re-enter key‚Ä¶" autocomplete="off" />
                <button class="eye" onclick="toggleEye('pKey2',this)">üëÅ</button>
              </div>
            </div>
          </div>

          <div class="g2" style="margin-bottom:14px">
            <div class="field">
              <label>Package size</label>
              <div class="unit-row">
                <input class="unit-in" type="number" id="pSize" value="512" min="1" />
                <select class="unit-sel" id="pUnit">
                  <option value="1024">KB</option>
                  <option value="1048576">MB</option>
                  <option value="1">B</option>
                </select>
              </div>
            </div>
            <div class="field">
              <label>Output name</label>
              <input class="inp" type="text" id="pOut" placeholder="auto-generated" />
            </div>
          </div>

          <hr class="sep" />

          <div class="btn-row">
            <button class="btn btn-blu" id="pBtn" onclick="runPack()">üì¶ Pack file</button>
            <button class="btn btn-gh" onclick="clrPack()">Clear</button>
          </div>

          <div class="prog" id="pProg">
            <div class="prog-top"><span id="pLbl">Processing‚Ä¶</span><span id="pPct">0%</span></div>
            <div class="prog-track">
              <div class="prog-fill" id="pBar"></div>
            </div>
          </div>
          <div class="note note-ok" id="pOk"><span>‚úî</span><span id="pOkT"></span></div>
          <div class="note note-er" id="pEr"><span>‚úñ</span><span id="pErT"></span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-hd"><span>üìã Log</span></div>
        <div class="card-bd" style="padding-bottom:0">
          <div class="log" id="pLog"><span class="ll hi">[MapPack] Ready. Select a file to pack.</span></div>
        </div>
      </div>

    </div><!-- /pack -->

    <!-- ‚ïê‚ïê UNPACK ‚ïê‚ïê -->
    <div class="view" id="v-unpack">

      <div class="card">
        <div class="card-hd"><span>üìÇ Package source</span></div>
        <div class="card-bd">
          <div class="field" style="position:relative">
            <label>Package path</label>
            <div class="path-row">
              <input class="path-input" id="uPath" readonly placeholder="No package selected ‚Äî click Browse" />
              <button class="path-btn" onclick="document.getElementById('uFile').click()">üìÅ Browse‚Ä¶</button>
              <input type="file" id="uFile" class="path-file" multiple />
            </div>
            <div class="hint" id="uHint">Select the .zip package produced by Pack</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-hd"><span>‚öô Unpack settings</span></div>
        <div class="card-bd">

          <div class="field">
            <label>Survey key</label>
            <div class="key-wrap">
              <input class="key-in" type="password" id="uKey" placeholder="Enter survey key‚Ä¶" autocomplete="off" />
              <button class="eye" onclick="toggleEye('uKey',this)">üëÅ</button>
            </div>
          </div>

          <hr class="sep" />

          <div class="btn-row">
            <button class="btn btn-grn" id="uBtn" onclick="runUnpack()">üìÇ Unpack file</button>
            <button class="btn btn-gh" onclick="clrUnpack()">Clear</button>
          </div>

          <div class="prog" id="uProg">
            <div class="prog-top"><span id="uLbl">Processing‚Ä¶</span><span id="uPct">0%</span></div>
            <div class="prog-track">
              <div class="prog-fill" id="uBar"></div>
            </div>
          </div>
          <div class="note note-ok" id="uOk"><span>‚úî</span><span id="uOkT"></span></div>
          <div class="note note-er" id="uEr"><span>‚úñ</span><span id="uErT"></span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-hd"><span>üìã Log</span></div>
        <div class="card-bd" style="padding-bottom:0">
          <div class="log" id="uLog"><span class="ll hi">[MapPack] Ready. Select a package to unpack.</span></div>
        </div>
      </div>

    </div><!-- /unpack -->

  </main>

  <footer>
    <span class="ok">‚óè Ready</span>
    <span>MapPack v2.1</span>
    <span style="margin-left:auto" id="ft"></span>
  </footer>

  <script>
    'use strict';

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CRYPTO  (AES-256-GCM + PBKDF2-SHA256)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const SALT = 32;   // bytes
    const IV = 12;   // bytes
    const ITER = 100000;
    const DESCR = '00000000.dat';
    const CHUNK_EXT = '.dat';

    async function deriveKey(passphrase, salt) {
      const raw = await crypto.subtle.importKey(
        'raw', new TextEncoder().encode(passphrase), 'PBKDF2', false, ['deriveKey']
      );
      return crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: ITER, hash: 'SHA-256' },
        raw, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
      );
    }

    async function encryptBlock(passphrase, plainBytes) {
      const salt = crypto.getRandomValues(new Uint8Array(SALT));
      const iv = crypto.getRandomValues(new Uint8Array(IV));
      const key = await deriveKey(passphrase, salt);
      const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, plainBytes);
      // Layout: [32 salt][12 iv][N ciphertext+authtag]  ‚Äî no markers, no labels
      const out = new Uint8Array(SALT + IV + ct.byteLength);
      out.set(salt, 0); out.set(iv, SALT); out.set(new Uint8Array(ct), SALT + IV);
      return out;
    }

    async function decryptBlock(passphrase, segBytes) {
      const b = new Uint8Array(segBytes);
      const key = await deriveKey(passphrase, b.slice(0, SALT));
      try {
        return new Uint8Array(
          await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: b.slice(SALT, SALT + IV) },
            key, b.slice(SALT + IV)
          )
        );
      } catch {
        throw new Error('Wrong survey key or corrupted package.');
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HELPERS
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function randHex(n) {
      const a = new Uint8Array(n);
      crypto.getRandomValues(a);
      return Array.from(a).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function fmtSize(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
      return (b / 1048576).toFixed(2) + ' MB';
    }

    function log(id, msg, cls = '') {
      const box = document.getElementById(id);
      const ts = new Date().toLocaleTimeString('en-GB', { hour12: false });
      const el = Object.assign(document.createElement('span'), {
        className: 'll ' + cls,
        textContent: '[' + ts + '] ' + msg
      });
      box.appendChild(document.createElement('br'));
      box.appendChild(el);
      box.scrollTop = box.scrollHeight;
    }

    function setProgress(barId, pctId, lblId, wrapId, pct, label) {
      document.getElementById(wrapId).classList.add('on');
      document.getElementById(barId).style.width = pct + '%';
      document.getElementById(pctId).textContent = pct + '%';
      if (label) document.getElementById(lblId).textContent = label;
    }

    function showNote(id, msg) {
      const el = document.getElementById(id);
      el.classList.add('on');
      const t = el.querySelector('span:last-child');
      if (t) t.textContent = msg;
    }
    function hideNote(id) { document.getElementById(id).classList.remove('on'); }

    function toggleEye(id, btn) {
      const inp = document.getElementById(id);
      inp.type = inp.type === 'password' ? 'text' : 'password';
      btn.textContent = inp.type === 'password' ? 'üëÅ' : 'üîí';
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TABS
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function sw(view, el) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
      document.getElementById('v-' + view).classList.add('on');
      el.classList.add('on');
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PACK
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    let packFile = null;

    document.getElementById('pFile').addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      packFile = f;
      document.getElementById('pPath').value = f.name + '   [' + fmtSize(f.size) + ']';
      document.getElementById('pOut').placeholder = 'map_' + randHex(3).toUpperCase();
      log('pLog', 'Loaded: ' + f.name + ' (' + fmtSize(f.size) + ')', 'hi');
    });

    function clrPack() {
      packFile = null;
      ['pPath', 'pKey', 'pKey2', 'pOut'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('pFile').value = '';
      document.getElementById('pSize').value = 512;
      document.getElementById('pProg').classList.remove('on');
      hideNote('pOk'); hideNote('pEr');
    }

    async function runPack() {
      hideNote('pOk'); hideNote('pEr');

      if (!packFile) return showNote('pEr', 'No file selected.');
      const pass = document.getElementById('pKey').value;
      const pass2 = document.getElementById('pKey2').value;
      if (!pass) return showNote('pEr', 'Survey key is required.');
      if (pass !== pass2) return showNote('pEr', 'Keys do not match. Please re-enter.');

      const chunkBytes = parseInt(document.getElementById('pSize').value)
        * parseInt(document.getElementById('pUnit').value);
      if (!chunkBytes || chunkBytes < 1) return showNote('pEr', 'Invalid package size.');

      const outName = (document.getElementById('pOut').value.trim() || 'map_' + randHex(3).toUpperCase())
        .replace(/[^\w\-]/g, '_');

      document.getElementById('pBtn').disabled = true;
      log('pLog', 'Starting pack‚Ä¶', 'hi');
      setProgress('pBar', 'pPct', 'pLbl', 'pProg', 2, 'Reading file‚Ä¶');

      const raw = new Uint8Array(await packFile.arrayBuffer());
      const chunks = [];
      for (let i = 0; i < raw.byteLength; i += chunkBytes) chunks.push(raw.slice(i, i + chunkBytes));

      // Random filenames with .kml extension ‚Äî looks like geo data, never flagged by AV
      const segNames = chunks.map(() => randHex(16) + CHUNK_EXT);
      log('pLog', 'Splitting into ' + chunks.length + ' segment(s) √ó ' + fmtSize(chunkBytes));

      // Encrypt manifest (stores original filename + segment order, all hidden)
      const manifest = new TextEncoder().encode(
        JSON.stringify({ n: packFile.name, s: segNames, t: Date.now() })
      );
      setProgress('pBar', 'pPct', 'pLbl', 'pProg', 7, 'Encoding manifest‚Ä¶');

      const zip = new JSZip();
      zip.file(DESCR, await encryptBlock(pass, manifest));  // .json extension ‚Äî AV-safe

      for (let i = 0; i < chunks.length; i++) {
        setProgress('pBar', 'pPct', 'pLbl', 'pProg',
          Math.round(7 + (i / chunks.length) * 87),
          'Encoding segment ' + (i + 1) + '/' + chunks.length + '‚Ä¶'
        );
        zip.file(segNames[i], await encryptBlock(pass, chunks[i]));
        await new Promise(r => setTimeout(r, 0)); // keep UI responsive
      }

      setProgress('pBar', 'pPct', 'pLbl', 'pProg', 97, 'Bundling‚Ä¶');
      const blob = await zip.generateAsync({ type: 'blob', compression: 'STORE' });
      setProgress('pBar', 'pPct', 'pLbl', 'pProg', 100, 'Done');

      const url = URL.createObjectURL(blob), a = document.createElement('a');
      a.href = url; a.download = outName + '.zip'; a.click();
      URL.revokeObjectURL(url);

      log('pLog', 'Package ready: ' + outName + '.zip (' + chunks.length + ' segments)', 'ok');
      showNote('pOk', outName + '.zip ‚Äî ' + chunks.length + ' segment(s)');
      document.getElementById('pBtn').disabled = false;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       UNPACK
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    let unpackFiles = [];

    document.getElementById('uFile').addEventListener('change', async e => {
      const files = Array.from(e.target.files);
      if (!files.length) return;
      unpackFiles = [];
      for (const f of files)
        unpackFiles.push({ name: f.name, data: await f.arrayBuffer(), isZip: f.name.endsWith('.zip') });
      const names = unpackFiles.map(f => f.name);
      document.getElementById('uPath').value = names.length === 1
        ? names[0] + '   [' + fmtSize(unpackFiles[0].data.byteLength) + ']'
        : names.length + ' files selected';
      document.getElementById('uHint').textContent = 'Package loaded ‚Äî ready to unpack';
      log('uLog', 'Package loaded: ' + names.join(', '), 'hi');
    });

    function clrUnpack() {
      unpackFiles = [];
      document.getElementById('uPath').value = '';
      document.getElementById('uFile').value = '';
      document.getElementById('uKey').value = '';
      document.getElementById('uHint').textContent = 'Select the .zip package produced by Pack';
      document.getElementById('uProg').classList.remove('on');
      hideNote('uOk'); hideNote('uEr');
    }

    async function runUnpack() {
      hideNote('uOk'); hideNote('uEr');

      const pass = document.getElementById('uKey').value;
      if (!pass) return showNote('uEr', 'Survey key is required.');
      if (!unpackFiles.length) return showNote('uEr', 'No package selected.');

      document.getElementById('uBtn').disabled = true;
      log('uLog', 'Starting unpack‚Ä¶', 'hi');
      setProgress('uBar', 'uPct', 'uLbl', 'uProg', 2, 'Reading package‚Ä¶');

      try {
        // Build segment map: filename ‚Üí ArrayBuffer
        const segMap = {};
        if (unpackFiles.length === 1 && unpackFiles[0].isZip) {
          const zip = await JSZip.loadAsync(unpackFiles[0].data);
          log('uLog', 'Bundle contains ' + Object.keys(zip.files).length + ' entries');
          for (const [name, file] of Object.entries(zip.files)) {
            if (file.dir) continue;
            segMap[name.split('/').pop()] = await file.async('arraybuffer');
          }
        } else {
          unpackFiles.forEach(f => { segMap[f.name] = f.data; });
        }

        setProgress('uBar', 'uPct', 'uLbl', 'uProg', 12, 'Reading manifest‚Ä¶');

        if (!segMap[DESCR])
          throw new Error('Manifest not found ‚Äî make sure you selected the correct package.');

        const manifest = JSON.parse(
          new TextDecoder().decode(await decryptBlock(pass, segMap[DESCR]))
        );
        log('uLog', 'Manifest OK ‚Äî original file: ' + manifest.n, 'ok');
        log('uLog', 'Expecting ' + manifest.s.length + ' segment(s)');

        const parts = [];
        for (let i = 0; i < manifest.s.length; i++) {
          const segName = manifest.s[i];
          setProgress('uBar', 'uPct', 'uLbl', 'uProg',
            Math.round(12 + (i / manifest.s.length) * 82),
            'Decoding segment ' + (i + 1) + '/' + manifest.s.length + '‚Ä¶'
          );
          if (!segMap[segName]) throw new Error('Missing segment: ' + segName);
          parts.push(await decryptBlock(pass, segMap[segName]));
          await new Promise(r => setTimeout(r, 0));
        }

        setProgress('uBar', 'uPct', 'uLbl', 'uProg', 97, 'Assembling‚Ä¶');

        const totalLen = parts.reduce((s, p) => s + p.byteLength, 0);
        const output = new Uint8Array(totalLen);
        let offset = 0;
        for (const p of parts) { output.set(p, offset); offset += p.byteLength; }

        setProgress('uBar', 'uPct', 'uLbl', 'uProg', 100, 'Done');

        const blob = new Blob([output]);
        const url = URL.createObjectURL(blob), a = document.createElement('a');
        a.href = url; a.download = manifest.n; a.click();
        URL.revokeObjectURL(url);

        log('uLog', 'Restored: ' + manifest.n + ' (' + fmtSize(totalLen) + ')', 'ok');
        showNote('uOk', manifest.n + ' ‚Äî ' + fmtSize(totalLen));

      } catch (err) {
        log('uLog', 'ERROR: ' + err.message, 'er');
        showNote('uEr', err.message);
      }

      document.getElementById('uBtn').disabled = false;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       FOOTER CLOCK
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function tick() {
      document.getElementById('ft').textContent =
        new Date().toLocaleTimeString('en-GB', { hour12: false });
    }
    setInterval(tick, 1000);
    tick();
  </script>
</body>

</html>